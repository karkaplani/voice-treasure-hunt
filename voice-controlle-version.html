<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Treasure Hunt</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #e0f7fa;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      text-align: center;
    }

    #gameContainer {
      max-width: 600px;
      margin: auto;
      padding: 16px;
      min-height: 450px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-sizing: border-box;
    }

    #title {
      font-family: 'Fredoka One', sans-serif;
      font-size: 36px;
      margin-bottom: 16px;
      color: #333;
    }

    #maze {
      display: none;
      margin-top: 12px;
      border: none;
    }

    #status {
      font-weight: bold;
      margin-top: 12px;
      display: none;
    }

    /* Buttons styling */
    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      transition: all 0.2s ease-in-out;
      text-decoration: none;
    }

    .btn-start {
      background: #4caf50;
    }

    /* Hover effect shared across all buttons */
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.2);
      filter: brightness(1.1);
    }

    /* Modal */
    #winModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modalContent {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      max-width: 250px;
    }

  </style>
</head>
<body>
  <audio id="bgMusic" src="https://clever-gecko-e407f1.netlify.app/background_music.mp3" loop></audio>

  <div id="gameContainer">
    <h3 id="title">ðŸ’° Treasure Hunt! ðŸ§­</h3>

    <canvas id="maze" width="300" height="300"></canvas>

    <p>
      <button id="toggleBtn" class="btn btn-start">ðŸŽ¤ Start Listening</button>
    </p>

    <p id="status">Say: north, south, west, east</p>
  </div>

  <!-- Win Modal -->
  <div id="winModal">
    <div class="modalContent">
      <h2>Well done! ðŸŽ‰</h2>
      <button id="retryBtn" class="btn btn-start">Play Again</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("maze");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const toggleBtn = document.getElementById("toggleBtn");
    const bgMusic = document.getElementById("bgMusic");
    const winModal = document.getElementById("winModal");
    const retryBtn = document.getElementById("retryBtn");
    bgMusic.volume = 0.1;

    const gridSize = 5;
    const cellSize = canvas.width / gridSize;
    let player = { x: 0, y: 0 };
    const goal = { x: 4, y: 3 };
    let animating = false;
    let animX = player.x * cellSize;
    let animY = player.y * cellSize;

    const pirateImg = new Image();
    pirateImg.src = "https://raw.githubusercontent.com/karkaplani/voice-treasure-hunt/refs/heads/main/pirate.png";
    const treasureImg = new Image();
    treasureImg.src = "https://raw.githubusercontent.com/karkaplani/voice-treasure-hunt/refs/heads/main/treasure.png";
    const rockImg = new Image();
    rockImg.src = "https://raw.githubusercontent.com/karkaplani/voice-treasure-hunt/refs/heads/main/rock.png";
    const mapImg = new Image();
    mapImg.src = "https://raw.githubusercontent.com/karkaplani/voice-treasure-hunt/refs/heads/main/treasure_map.png";

    const obstacles = [
      {x:3, y:0}, {x:3, y:1}, {x:1, y:1}, {x:0, y:3},
      {x:0, y:1}, {x:3, y:2}, {x:4, y:2}, {x:0, y:2},
      {x:2, y:3}, {x:4, y:4}, {x:0, y:4}
    ];

    function resetGame() {
      animX = player.x = 0;
      animY = player.y = 0;
      canvas.style.display = "none";
      toggleBtn.style.display = "inline-block";
      statusEl.style.display = "none";
      winModal.style.display = "none";
      bgMusic.pause();
      bgMusic.currentTime = 0;
      drawMaze();
    }

    retryBtn.addEventListener("click", () => {
      winModal.style.display = "none";
      resetGame();
      statusEl.innerText = "Game restarted! Say: north, south, west, east";
    });

    function drawMaze() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);
      obstacles.forEach(cell => {
        ctx.drawImage(rockImg, cell.x * cellSize, cell.y * cellSize, cellSize, cellSize);
      });
      ctx.drawImage(treasureImg, goal.x * cellSize, goal.y * cellSize, cellSize, cellSize);
      ctx.drawImage(pirateImg, animX, animY, cellSize, cellSize);
    }

    function animateMove(targetX, targetY, callback) {
      animating = true;
      const startX = animX;
      const startY = animY;
      const endX = targetX * cellSize;
      const endY = targetY * cellSize;
      const duration = 200;
      const startTime = performance.now();

      function step(time) {
        const t = Math.min((time - startTime) / duration, 1);
        animX = startX + (endX - startX) * t;
        animY = startY + (endY - startY) * t;
        drawMaze();
        if (t < 1) requestAnimationFrame(step);
        else { animating = false; if (callback) callback(); }
      }
      requestAnimationFrame(step);
    }

    function movePlayer(direction) {
      if (animating) return;
      let targetX = player.x;
      let targetY = player.y;
      switch(direction) {
        case "north": targetY--; break;
        case "south": targetY++; break;
        case "west": targetX--; break;
        case "east": targetX++; break;
      }
      if(targetX < 0 || targetX >= gridSize || targetY < 0 || targetY >= gridSize) return;
      if(obstacles.some(o => o.x === targetX && o.y === targetY)) {
        statusEl.innerText = `â›” Cannot move ${direction}, obstacle in the way!`;
        return;
      }
      player.x = targetX;
      player.y = targetY;
      animateMove(targetX, targetY, () => {
        if(player.x === goal.x && player.y === goal.y) winModal.style.display = "flex";
        else statusEl.innerText = `Moved ${direction}`;
      });
    }

    // Speech recognition
    if(!("webkitSpeechRecognition" in window)) {
      statusEl.innerText = "âŒ Speech recognition not supported in this browser.";
    } else {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.continuous = true;

      let listening = false;
      toggleBtn.addEventListener("click", () => {
        if(!listening) {
          recognition.start();
          listening = true;
          toggleBtn.innerText = "ðŸ›‘ Stop Listening";
          statusEl.style.display = "block";
          statusEl.innerText = "Listening... Say: north, south, west, east";
          canvas.style.display = "block";
          bgMusic.play().catch(console.log);
        } else {
          recognition.stop();
          listening = false;
          toggleBtn.innerText = "ðŸŽ¤ Start Listening";
          statusEl.innerText = "Stopped listening.";
        }
      });

      recognition.onresult = (event) => {
        const spoken = event.results[event.results.length-1][0].transcript.toLowerCase().trim();

        // Pattern-based detection
        let detectedDirection = null;
        if(spoken.includes("north")) detectedDirection = "north";
        else if(spoken.includes("south")) detectedDirection = "south";
        else if(spoken.includes("west"))  detectedDirection = "west";
        else if(spoken.includes("east"))  detectedDirection = "east";

        if(detectedDirection) {
          statusEl.innerText = `Heard: "${spoken}" â†’ moving ${detectedDirection}`;
          movePlayer(detectedDirection);
        } else {
          statusEl.innerText = `Didn't understand: "${spoken}"`;
        }
      };


      recognition.onerror = (event) => {
        statusEl.innerText = "Error: " + event.error;
      };
    }

    // Wait for images
    let imagesLoaded = 0;
    const totalImages = 4;
    function checkAllLoaded() {
      imagesLoaded++;
      if(imagesLoaded === totalImages) resetGame();
    }
    pirateImg.onload = checkAllLoaded;
    treasureImg.onload = checkAllLoaded;
    rockImg.onload = checkAllLoaded;
    mapImg.onload = checkAllLoaded;
  </script>
</body>
</html>
